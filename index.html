<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Fornecedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #f6f3f5;
        }

        .custom-container {
            background-color: #343f53 !important;
        }

        .custom-text-light {
            color: #d1d5db;
        }

        .custom-text-dark {
            color: #e8e5eb;
        }

        .custom-border {
            border-color: #6b7280;
        }

        .custom-bg-indigo {
            background-color: #4e46e500;
        }

        .custom-text-indigo {
            color: #c7d2fe;
        }

        .custom-hover-indigo:hover {
            background-color: #6b7280;
        }

        .table-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .shadow-custom {
            box-shadow: 0 12px 30px -5px rgba(0, 0, 0, 0.15), 0 12px 12px -5px rgba(0, 0, 0, 0.06);
        }

        .btn-hover {
            transition: background-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        input {
            background-color: #4b5563 !important;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .custom-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .copyable {
            cursor: pointer;
            position: relative;
        }

        .copyable:hover {
            background-color: #6b7280;
        }

        .copied {
            position: relative;
            /* Necessário para o posicionamento do ::after */
            display: inline-block;
        }

        .copied::after {
            content: 'Copiado!';
            position: absolute;
            top: 20%;
            left: 100%;
            /* Posiciona o balão à direita do texto */
            transform: translateY(-50%);
            /* Centraliza verticalmente em relação ao texto */
            margin-left: 25px;
            /* Espaçamento entre o texto e o balão */

            background-color: #9ed88f;
            color: rgb(49, 82, 90);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            animation: fadeInOut 1.5s ease forwards;
        }



        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -10px);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -10px);
            }
        }

        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #4b5563;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 10px;
            border: 3px solid #4b5563;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }

        .sort-icon {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 8px;
        }

        .sort-icon .tooltip {
            visibility: hidden;
            width: 150px;
            height: auto;
            background-color: rgba(99, 102, 241, 0.9);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 9999;
            top: 50%;
            right: calc(100% + 10px);
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .sort-icon .tooltip::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent transparent rgba(99, 102, 241, 0.9);
        }

        .sort-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .sort-icon.active svg {
            color: #6366f1;
        }

        .sort-icon.desc svg {
            transform: rotate(180deg);
        }

        .tooltip-field {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .tooltip-field .tooltip {
            visibility: hidden;
            width: 200px;
            background-color: rgba(99, 102, 241, 0.9);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 9999;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .tooltip-field .tooltip::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(99, 102, 241, 0.9) transparent;
        }

        .tooltip-field:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(28, 83, 119, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .swal2-popup {
            background-color: #1f2937 !important;
            color: #e5e7eb !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(37, 108, 175, 0.705) !important;
        }

        .swal2-title {
            color: #e5e7eb !important;
        }

        .swal2-content {
            color: #d1d5db !important;
        }

        .swal2-confirm {
            background-color: #6366f1 !important;
        }

        .swal2-cancel {
            background-color: #ef4444 !important;
        }

        .swal2-timer-progress-bar {
            background-color: #3274aa !important;
        }
    </style>
</head>

<body class="p-4">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="custom-container rounded-xl p-6 w-full h-full shadow-custom">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-center custom-bg-indigo">Cadastro de Fornecedores</h1>
        </div>

        <!-- Formulário -->
        <form id="supplierForm" class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
            <div class="md:col-span-2 tooltip-field">
                <label for="codFornecedor" class="block text-sm font-medium custom-text-light">Cód. Fornecedor</label>
                <input type="text" id="codFornecedor" required
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    oninput="checkFormValidity()">
                <span class="tooltip">Código único para identificar o fornecedor no sistema</span>
                <p id="codError" class="text-red-500 text-sm mt-1 hidden">Código já cadastrado!</p>
            </div>
            <div class="md:col-span-3 tooltip-field">
                <label for="cnpj" class="block text-sm font-medium custom-text-light">CNPJ</label>
                <input type="text" id="cnpj" required
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    placeholder="00.000.000/0000-00">
                <span class="tooltip">Número de identificação fiscal do fornecedor</span>
            </div>
            <div class="md:col-span-5">
                <label for="nomeFornecedor" class="block text-sm font-medium custom-text-light">Nome Fornecedor</label>
                <input type="text" id="nomeFornecedor" required
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    oninput="checkFormValidity()">
            </div>
            <div class="md:col-span-2 tooltip-field">
                <label for="centroCusto" class="block text-sm font-medium custom-text-light">Centro Custo</label>
                <input type="text" id="centroCusto"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light">
                <span class="tooltip">Código do centro de custo associado ao fornecedor</span>
            </div>
            <div class="md:col-span-12 flex justify-center">
                <button type="submit"
                    class="bg-indigo-600 text-white py-2 px-6 rounded-md hover:bg-indigo-700 btn-hover font-medium disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2"
                    id="submitButton" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>Cadastrar</span>
                </button>
            </div>
        </form>

        <!-- Filtros e Botões de Backup -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
            <div class="md:col-span-4">
                <label for="filterCod" class="block text-sm font-medium custom-text-light">Filtrar por Cód.
                    Fornecedor</label>
                <input type="text" id="filterCod"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light">
            </div>
            <div class="md:col-span-4">
                <label for="filterCnpj" class="block text-sm font-medium custom-text-light">Filtrar por CNPJ</label>
                <input type="text" id="filterCnpj"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    placeholder="00.000.000/0000-00">
            </div>
            <div class="md:col-span-4">
                <label for="filterNome" class="block text-sm font-medium custom-text-light">Filtrar por Nome</label>
                <input type="text" id="filterNome"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light">
            </div>
            <div class="md:col-span-12 flex justify-end space-x-4">
                <button id="exportJson"
                    class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 btn-hover font-medium flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 0116 8c0 2.757-2.243 5-5 5H8m0 4l-4-4m0 0l4-4m0 4h12" />
                    </svg>
                    <span>Exportar JSON</span>
                </button>
                <label for="importJson"
                    class="bg-purple-600 text-white py-2 px-6 rounded-md hover:bg-purple-700 btn-hover font-medium cursor-pointer flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16a4 4 0 00.88-7.903A5 5 0 008 8c0 2.757 2.243 5 5 5h3m0 4l4-4m0 0l-4-4m0 4H4" />
                    </svg>
                    <span>Importar JSON</span>
                </label>
                <input type="file" id="importJson" accept=".json" class="hidden">
                <button id="exportExcel"
                    class="bg-emerald-600 text-white py-2 px-6 rounded-md hover:bg-emerald-700 btn-hover font-medium flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5l2 2h4a2 2 0 012 2v12a2 2 0 01-2 2z" />
                    </svg>
                    <span>Exportar para Excel</span>
                </button>
            </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
            <table id="supplierTable" class="w-full text-sm text-left custom-text-light">
                <thead class="text-xs custom-text-light uppercase bg-indigo-700 sticky-header">
                    <tr>
                        <th class="px-6 py-3" id="quantityHeader">
                            Qtd. (0)
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                Cód. Fornecedor
                                <span class="sort-icon" onclick="sortTable('codFornecedor', 'numeric')"
                                    data-tooltip="Ordem numérica">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem numérica</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                CNPJ
                                <span class="sort-icon" onclick="sortTable('cnpj', 'numeric')"
                                    data-tooltip="Ordem numérica">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem numérica</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                Nome Fornecedor
                                <span class="sort-icon" onclick="sortTable('nomeFornecedor', 'string')"
                                    data-tooltip="Ordem alfabética">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem alfabética</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                Centro de Custo
                                <span class="sort-icon" onclick="sortTable('centroCusto', 'numeric')"
                                    data-tooltip="Ordem numérica">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem numérica</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let currentSort = { column: null, direction: 'asc', type: null };

        // Validar código do fornecedor
        function checkCodFornecedor(cod) {
            const codError = document.getElementById('codError');
            const editIndex = document.getElementById('supplierForm').dataset.editIndex;
            const codExists = suppliers.some((s, i) => s.codFornecedor === cod.trim() && (editIndex ? i !== parseInt(editIndex) : true));
            if (codExists && cod.trim() !== '') {
                codError.classList.remove('hidden');
                return false;
            } else {
                codError.classList.add('hidden');
                return true;
            }
        }

        // Validar formulário e ativar/desativar botão
        function checkFormValidity() {
            const codFornecedor = document.getElementById('codFornecedor').value.trim();
            const cnpj = document.getElementById('cnpj').value.trim();
            const nomeFornecedor = document.getElementById('nomeFornecedor').value.trim();
            const submitButton = document.getElementById('submitButton');
            const isCodValid = checkCodFornecedor(codFornecedor);
            submitButton.disabled = !(isCodValid && codFornecedor && cnpj && nomeFornecedor);
        }

        // Validar CNPJ com dígitos verificadores
        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g, '');
            if (cnpj === '') return false;
            if (cnpj.length !== 14) return false;
            if (/^(\d)\1+$/.test(cnpj)) return false;
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;
            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(1)) return false;
            return true;
        }

        // Formatar CNPJ corretamente
        function formatCNPJ(cnpj, isInput = true) {
            let value = isInput ? cnpj.replace(/\D/g, '') : cnpj.toString().replace(/\D/g, '');
            if (value.length > 2) value = value.substring(0, 2) + '.' + value.substring(2);
            if (value.length > 6) value = value.substring(0, 6) + '.' + value.substring(6);
            if (value.length > 10) value = value.substring(0, 10) + '/' + value.substring(10);
            if (value.length > 15) value = value.substring(0, 15) + '-' + value.substring(15);
            value = value.substring(0, 18);
            return value;
        }

        // Formatar CNPJ no campo principal
        document.getElementById('cnpj').addEventListener('input', function (e) {
            const start = e.target.selectionStart;
            const end = e.target.selectionEnd;
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) value = value.substring(0, 2) + '.' + value.substring(2);
            if (value.length > 6) value = value.substring(0, 6) + '.' + value.substring(6);
            if (value.length > 10) value = value.substring(0, 10) + '/' + value.substring(10);
            if (value.length > 15) value = value.substring(0, 15) + '-' + value.substring(15);
            value = value.substring(0, 18);
            e.target.value = value;
            let adjustedStart = start;
            let adjustedEnd = end;
            if (start > 2 && value.charAt(2) === '.') adjustedStart += 1;
            if (start > 6 && value.charAt(6) === '.') adjustedStart += 1;
            if (start > 10 && value.charAt(10) === '/') adjustedStart += 1;
            if (start > 15 && value.charAt(15) === '-') adjustedStart += 1;
            if (end > 2 && value.charAt(2) === '.') adjustedEnd += 1;
            if (end > 6 && value.charAt(6) === '.') adjustedEnd += 1;
            if (end > 10 && value.charAt(10) === '/') adjustedEnd += 1;
            if (end > 15 && value.charAt(15) === '-') adjustedEnd += 1;
            e.target.setSelectionRange(adjustedStart, adjustedEnd);
            if (value.length === 18 && validarCNPJ(value)) {
                fetchCNPJData(value);
            }
            checkFormValidity();
        });

        // Formatar e filtrar CNPJ no campo de filtro
        document.getElementById('filterCnpj').addEventListener('input', function (e) {
            const start = e.target.selectionStart;
            const end = e.target.selectionEnd;
            let value = e.target.value.replace(/\D/g, '');
            let formattedValue = value;
            if (value.length > 2) formattedValue = value.substring(0, 2) + '.' + value.substring(2);
            if (value.length > 5) formattedValue = formattedValue.substring(0, 6) + '.' + formattedValue.substring(6);
            if (value.length > 8) formattedValue = formattedValue.substring(0, 10) + '/' + formattedValue.substring(10);
            if (value.length > 12) formattedValue = formattedValue.substring(0, 15) + '-' + formattedValue.substring(15);
            formattedValue = formattedValue.substring(0, 18);
            e.target.value = formattedValue;
            let adjustedStart = start;
            let adjustedEnd = end;
            if (value.length >= 3 && start > 2) adjustedStart += 1;
            if (value.length >= 6 && start > 6) adjustedStart += 1;
            if (value.length >= 9 && start > 10) adjustedStart += 1;
            if (value.length >= 13 && start > 15) adjustedStart += 1;
            if (value.length >= 3 && end > 2) adjustedEnd += 1;
            if (value.length >= 6 && end > 6) adjustedEnd += 1;
            if (value.length >= 9 && end > 10) adjustedEnd += 1;
            if (value.length >= 13 && end > 15) adjustedEnd += 1;
            e.target.setSelectionRange(adjustedStart, adjustedEnd);
            updateTable();
        });

        // Consultar CNPJ com loading
        async function fetchCNPJData(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (!validarCNPJ(cnpj)) return;
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                if (!response.ok) {
                    throw new Error('CNPJ não encontrado ou erro na API');
                }
                const data = await response.json();
                if (data.razao_social) {
                    document.getElementById('nomeFornecedor').value = data.razao_social;
                    checkFormValidity();
                    Swal.fire({
                        title: 'Dados encontrados!',
                        text: `Razão social: ${data.razao_social}`,
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            } catch (error) {
                console.error('Erro ao consultar CNPJ:', error);
                Swal.fire({
                    title: 'Erro na consulta',
                    text: error.message,
                    icon: 'error',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Salvar dados no localStorage
        function saveData() {
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
        }

        // Adicionar ou atualizar fornecedor
        document.getElementById('supplierForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const codFornecedor = document.getElementById('codFornecedor').value.trim();
            const cnpj = document.getElementById('cnpj').value.trim();
            const nomeFornecedor = document.getElementById('nomeFornecedor').value.trim();
            const centroCusto = document.getElementById('centroCusto').value.trim();
            const editIndex = this.dataset.editIndex;

            if (!validarCNPJ(cnpj)) {
                Swal.fire({
                    title: 'CNPJ inválido!',
                    text: 'Por favor, insira um CNPJ válido com dígitos verificadores corretos.',
                    icon: 'error',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }

            if (editIndex) {
                suppliers[parseInt(editIndex)] = {
                    codFornecedor,
                    cnpj: cnpj.replace(/\D/g, ''),
                    nomeFornecedor,
                    centroCusto,
                    timestamp: suppliers[parseInt(editIndex)].timestamp
                };
                delete this.dataset.editIndex;
                Swal.fire({
                    title: 'Fornecedor atualizado!',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                const cnpjExists = suppliers.some(s => s.cnpj === cnpj.replace(/\D/g, ''));
                if (cnpjExists) {
                    Swal.fire({
                        title: 'CNPJ já cadastrado!',
                        text: 'Este CNPJ já está cadastrado no sistema.',
                        icon: 'warning',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    return;
                }
                suppliers.push({
                    codFornecedor,
                    cnpj: cnpj.replace(/\D/g, ''),
                    nomeFornecedor,
                    centroCusto,
                    timestamp: new Date().getTime()
                });
                Swal.fire({
                    title: 'Fornecedor cadastrado!',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            }

            saveData();
            updateTable();
            this.reset();
            checkFormValidity();
        });

        // Copiar texto com confirmação visual
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                });
                toast.fire({
                    icon: 'success',
                    title: 'Conteúdo copiado!'
                });
                element.classList.add('copied');
                setTimeout(() => element.classList.remove('copied'), 1500);
            });
        }

        // Ordenar tabela
        function sortTable(column, type) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
                currentSort.type = type;
            }

            const sortIcon = document.querySelector(`.sort-icon[onclick*="sortTable('${column}'"]`);
            const tooltip = sortIcon.querySelector('.tooltip');
            let newTooltipText = column === 'nomeFornecedor'
                ? (sortIcon.dataset.tooltip === 'Ordem alfabética' ? 'Ordem por criação' : 'Ordem alfabética')
                : (sortIcon.dataset.tooltip === 'Ordem numérica' ? 'Ordem por criação' : 'Ordem numérica');
            sortIcon.dataset.tooltip = newTooltipText;
            tooltip.textContent = newTooltipText;

            suppliers.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                if (column === 'cnpj') {
                    valueA = valueA.replace(/\D/g, '');
                    valueB = valueB.replace(/\D/g, '');
                }
                if (type === 'numeric') {
                    valueA = Number(valueA) || 0;
                    valueB = Number(valueB) || 0;
                } else if (type === 'date') {
                    valueA = new Date(valueA).getTime();
                    valueB = new Date(valueB).getTime();
                } else {
                    valueA = String(valueA).toLowerCase();
                    valueB = String(valueB).toLowerCase();
                }
                if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            updateTable();
        }

        // Atualizar tabela
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            const filterCod = document.getElementById('filterCod').value.toLowerCase();
            const filterCnpj = document.getElementById('filterCnpj').value.replace(/\D/g, '');
            const filterNome = document.getElementById('filterNome').value.toLowerCase();

            const filteredSuppliers = suppliers.filter(supplier => {
                const cleanCnpj = supplier.cnpj.replace(/\D/g, '');
                return (
                    supplier.codFornecedor.toLowerCase().includes(filterCod) &&
                    cleanCnpj.includes(filterCnpj) &&
                    supplier.nomeFornecedor.toLowerCase().includes(filterNome)
                );
            });

            document.getElementById('quantityHeader').textContent = `Qtd. (${suppliers.length})`;

            tableBody.innerHTML = '';
            filteredSuppliers.forEach((supplier, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-700 border-b custom-hover-indigo';
                row.innerHTML = `
                    <td class="px-6 py-4 custom-text-light">${index + 1}</td>
                    <td class="px-6 py-4 copyable custom-text-light" onclick="copyToClipboard('${supplier.codFornecedor}', this)">${supplier.codFornecedor}</td>
                    <td class="px-6 py-4 copyable custom-text-light" onclick="copyToClipboard('${formatCNPJ(supplier.cnpj, false)}', this)">${formatCNPJ(supplier.cnpj, false)}</td>
                    <td class="px-6 py-4 copyable custom-text-light" onclick="copyToClipboard('${supplier.nomeFornecedor}', this)">${supplier.nomeFornecedor}</td>
                    <td class="px-6 py-4">
                        <input type="text" value="${supplier.centroCusto}" class="w-full border rounded p-1 bg-gray-600 custom-border custom-text-light"
                            onchange="updateCostCenter(${index}, this.value)">
                    </td>
                    <td class="px-6 py-4 flex space-x-2">
                        <button onclick="editSupplier(${index})" class="custom-text-indigo hover:text-indigo-200 btn-hover">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${index})" class="text-red-400 hover:text-red-300 btn-hover">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4M9 7v12m6-12v12" />
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active', 'desc');
            });

            const currentIcon = document.querySelector(`.sort-icon[onclick*="${currentSort.column}"]`);
            if (currentIcon) {
                currentIcon.classList.add('active');
                if (currentSort.direction === 'desc') {
                    currentIcon.classList.add('desc');
                }
            }
        }

        // Atualizar centro de custo
        function updateCostCenter(index, value) {
            suppliers[index].centroCusto = value;
            saveData();
            updateTable();
        }

        // Editar fornecedor
        function editSupplier(index) {
            const supplier = suppliers[index];
            document.getElementById('codFornecedor').value = supplier.codFornecedor;
            document.getElementById('cnpj').value = formatCNPJ(supplier.cnpj, false);
            document.getElementById('nomeFornecedor').value = supplier.nomeFornecedor;
            document.getElementById('centroCusto').value = supplier.centroCusto;
            document.getElementById('supplierForm').dataset.editIndex = index;
            checkFormValidity();
            document.getElementById('supplierForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Confirmar exclusão
        function confirmDelete(index) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Você não poderá reverter isso! Exclusão em 3 segundos.",
                icon: 'warning',
                showCancelButton: true,
                cancelButtonColor: '#ef4444',
                cancelButtonText: 'Cancelar',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            }).then((result) => {
                if (result.isConfirmed || result.dismiss === Swal.DismissReason.timer) {
                    suppliers.splice(index, 1);
                    saveData();
                    updateTable();
                    Swal.fire({
                        title: 'Excluído!',
                        text: 'O fornecedor foi removido.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            });
        }

        // Exportar JSON
        document.getElementById('exportJson').addEventListener('click', function () {
            if (suppliers.length === 0) {
                Swal.fire({
                    title: 'Nenhum dado para exportar',
                    text: 'Adicione fornecedores antes de exportar',
                    icon: 'warning',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }
            const exportData = suppliers.map(s => ({
                codFornecedor: s.codFornecedor,
                cnpj: s.cnpj,
                nomeFornecedor: s.nomeFornecedor,
                centroCusto: s.centroCusto,
                timestamp: s.timestamp
            }));
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fornecedores.json';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire({
                title: 'Exportado com sucesso!',
                text: 'O arquivo JSON foi gerado.',
                icon: 'success',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Importar JSON
        document.getElementById('importJson').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error('Arquivo JSON deve conter uma lista de fornecedores');
                    const validData = importedData.every(s =>
                        s.codFornecedor &&
                        typeof s.codFornecedor === 'string' &&
                        s.cnpj &&
                        validarCNPJ(s.cnpj) &&
                        s.nomeFornecedor &&
                        typeof s.nomeFornecedor === 'string' &&
                        (s.centroCusto === undefined || typeof s.centroCusto === 'string') &&
                        s.timestamp &&
                        typeof s.timestamp === 'number'
                    );
                    if (!validData) throw new Error('Dados inválidos no arquivo JSON. Verifique se todos os fornecedores têm codFornecedor, cnpj válido, nomeFornecedor e timestamp.');
                    const uniqueCnpjs = new Set(importedData.map(s => s.cnpj));
                    if (uniqueCnpjs.size !== importedData.length) throw new Error('CNPJs duplicados encontrados no arquivo JSON');
                    const uniqueCodes = new Set(importedData.map(s => s.codFornecedor));
                    if (uniqueCodes.size !== importedData.length) throw new Error('Códigos de fornecedor duplicados encontrados no arquivo JSON');
                    suppliers = importedData;
                    saveData();
                    updateTable();
                    Swal.fire({
                        title: 'Importado com sucesso!',
                        text: 'Os dados foram restaurados.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                } catch (error) {
                    Swal.fire({
                        title: 'Erro na importação',
                        text: error.message,
                        icon: 'error',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
                e.target.value = '';
            };
            reader.readAsText(file);
        });

        // Exportar para Excel
        document.getElementById('exportExcel').addEventListener('click', function () {
            if (suppliers.length === 0) {
                Swal.fire({
                    title: 'Nenhum dado para exportar',
                    text: 'Adicione fornecedores antes de exportar',
                    icon: 'warning',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }
            const data = suppliers.map(s => ({
                'Cód. Fornecedor': s.codFornecedor,
                'CNPJ': formatCNPJ(s.cnpj, false),
                'Nome Fornecedor': s.nomeFornecedor,
                'Centro de Custo': s.centroCusto,
                'Data Cadastro': new Date(s.timestamp).toLocaleString()
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Fornecedores');
            XLSX.writeFile(wb, 'fornecedores.xlsx');
            Swal.fire({
                title: 'Exportado com sucesso!',
                text: 'O arquivo Excel foi gerado.',
                icon: 'success',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Filtros automáticos
        document.getElementById('filterCod').addEventListener('input', updateTable);
        document.getElementById('filterNome').addEventListener('input', updateTable);
        document.getElementById('nomeFornecedor').addEventListener('input', checkFormValidity);
        document.getElementById('codFornecedor').addEventListener('input', checkFormValidity);

        // Carregar tabela ao iniciar
        updateTable();
    </script>
</body>

</html>
