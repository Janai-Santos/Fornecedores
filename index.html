<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Fornecedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #f6f3f5;
            font-family: poppins, Arial, Helvetica, sans-serif;
        }

        .custom-container {
            background-color: #343f53 !important;
        }

        .custom-text-light {
            color: #d1d5db;
        }

        .custom-text-dark {
            color: #e8e5eb;
        }

        .custom-border {
            border-color: #6b7280;
        }

        .custom-bg-indigo {
            background-color: #4e46e500;
        }

        .custom-text-indigo {
            color: #c7d2fe;
        }

        .custom-hover-indigo:hover {
            background-color: #6b7280;
        }

        .table-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .shadow-custom {
            box-shadow: 0 12px 30px -5px rgba(0, 0, 0, 0.15), 0 12px 12px -5px rgba(0, 0, 0, 0.06);
        }

        .btn-hover {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-hover:hover {
            transform: translateY(-2px);
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        input {
            background-color: #4b5563 !important;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .custom-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .copyable {
            cursor: pointer;
            position: relative;
        }

        .copyable:hover {
            background-color: #6b7280;
        }

        .copied {
            position: relative;
            display: inline-block;
        }

        .copied::after {
            content: 'Copiado!';
            position: absolute;
            top: 20%;
            left: 100%;
            transform: translateY(-50%);
            margin-left: 25px;
            background-color: #c8ddb6;
            color: rgb(58, 141, 86);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            animation: fadeInOut 1.5s ease forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -10px);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -10px);
            }
        }

        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #4b5563;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 10px;
            border: 3px solid #4b5563;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }

        .custom-header-bg {
            background-color: #5277a8; /* Um tom de verde-azulado, por exemplo */
            color: #cfcfcf;
        }

        .sort-icon {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 8px;
        }

        .sort-icon .tooltip {
            visibility: hidden;
            width: 150px;
            height: auto;
            background-color: rgba(99, 102, 241, 0.9);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 9999;
            top: 50%;
            right: calc(100% + 10px);
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .sort-icon .tooltip::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent transparent rgba(99, 102, 241, 0.9);
        }

        .sort-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .sort-icon.active svg {
            color: #6366f1;
        }

        .sort-icon.desc svg {
            transform: rotate(180deg);
        }

        .tooltip-field {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .tooltip-field .tooltip {
            visibility: hidden;
            width: 200px;
            background-color: rgba(99, 102, 241, 0.9);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 9999;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .tooltip-field .tooltip::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(99, 102, 241, 0.9) transparent;
        }

        .tooltip-field:hover .tooltip {
            visibility: visible;    
            opacity: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.568);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .swal2-popup {
            background-color: #1f2937 !important;
            color: #e5e7eb !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(37, 108, 175, 0.705) !important;
        }

        .swal2-title {
            color: #e5e7eb !important;
        }

        .swal2-content {
            color: #d1d5db !important;
        }

        .swal2-confirm {
            background-color: #6366f1 !important;
        }

        .swal2-cancel {
            background-color: #ef4444 !important;
        }

        .swal2-timer-progress-bar {
            background-color: #3274aa !important;
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: linear-gradient(145deg, #2d3748 0%, #1f2937 100%);
            border: 1px solid #4b5563;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            min-width: 260px;
            padding: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 600;
            color: #a5b4fc;
            border-bottom: 1px solid #4b5563;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item {
            padding: 12px 16px;
            color: #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #4b5563;
            transform: translateX(4px);
            color: #ffffff;
        }

        .dropdown-item.danger {
            color: #f87171;
        }

        .dropdown-item.danger:hover {
            background-color: #7f1d1d;
            color: #ffffff;
        }

        .dropdown-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #6366f1;
            cursor: pointer;
        }

        .dropdown-item label {
            cursor: pointer;
            font-size: 14px;
            flex-grow: 1;
        }

        .dropdown-item:focus-within {
            background-color: #4b5563;
            outline: 2px solid #c963f1;
            outline-offset: -2px;
        }

        .filter-button {
            position: relative;
        }

        .filter-button .tooltip {
            visibility: hidden;
            width: 150px;
            background-color: rgba(99, 102, 241, 0.9);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 9999;
            top: 50%;
            right: calc(100% + 10px);
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .filter-button:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        #customFilterButton:hover {
            transform: scale(1.1);
            /* Efeito de zoom no botão inteiro */
            transition: transform 0.3s ease;
            /* Transição suave */
        }

        #customFilterButton:hover svg {
            transform: scale(1);
            /* Remove o zoom individual do SVG para evitar sobreposição */
        }

        #customFilterButton.btn-hover:hover {
            transform: scale(1.1);
            /* Garante que o zoom seja aplicado, sobrescrevendo o efeito de subir */
        }

        .filter-button .tooltip::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent transparent rgba(144, 145, 173, 0.9);
        }

        .filter-dropdown {
            background-color: #1f2937;
            border: 1px solid #6b7280;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 400px;
            z-index: 1000;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #d1d5db;
            margin-bottom: 5px;
        }

        .filter-group .range-container {
            display: flex;
            gap: 10px;
        }

        .filter-group .range-container input {
            width: 100%;
            padding: 8px;
            border: 1px solid #6b7280;
            border-radius: 4px;
            background-color: #4b5563;
            color: #e5e7eb;
        }

        .filter-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .filter-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.2s;
        }

        .filter-actions button:hover {
            transform: translateY(-2px);
        }

        .icon-button {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            /* Ajustado de 32px para 40px para acomodar ícones e setas maiores */
            height: 80px;
            /* Ajustado de 32px para 40px para acomodar ícones e setas maiores */
            cursor: pointer;
            position: relative;
            top: 15px;
        }

        .icon-button img {
            width: 45px;
            height: 45px;
            transition: transform 0.3s ease;
            /* animação suave */
        }

        .icon-button:hover img {
            transform: scale(1.1);
        }


        .icon-button .tooltip {
            visibility: hidden;
            width: 140px;
            background-color: rgb(255, 255, 255);
            color: rgb(0, 0, 0);
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 9999;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90vw;
            /* nunca ultrapasse 90% da largura da tela */
            word-wrap: break-word;
            white-space: normal;
            white-space: normal;
            /* permite quebra de linha se for necessário */
        }

        .icon-button .tooltip::after {
            content: "";
            position: fixed;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(255, 255, 255, 0.9) transparent;
        }

        .icon-button:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .icon-button svg {
            width: 20px;
            /* Ajustado de 16px para 24px para aumentar o tamanho da seta */
            height: 20px;
            /* Ajustado de 16px para 24px para aumentar o tamanho da seta */
            margin-left: 4px;
            color: #efd1fd;
        }
    </style>
</head>

<body class="p-4">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="custom-container rounded-xl p-6 w-full h-full shadow-custom">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-center custom-bg-indigo">Cadastro de Fornecedores</h1>
            <div class="dropdown-container">
                <button id="settingsButton"
                    class="text-white p-2 rounded-md hover:bg-gray-600 btn-hover focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <div id="settingsMenu" class="dropdown-menu">
                    <div class="dropdown-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Configurações
                    </div>
                    <div class="dropdown-item" id="toggleCodValidation">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <label for="validateCod">Validar Código Fornecedor</label>
                        <input type="checkbox" id="validateCod" checked>
                    </div>
                    <div class="dropdown-item danger" id="clearAllData">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4M9 7v12m6-12v12" />
                        </svg>
                        <span>Apagar Todos os Dados</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário -->
        <form id="supplierForm" class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
            <div class="md:col-span-2 tooltip-field">
                <label for="codFornecedor" class="block text-sm font-medium custom-text-light">Cód. Fornecedor</label>
                <input type="text" id="codFornecedor" required
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    oninput="checkFormValidity()">
                <span class="tooltip">Código único para identificar o fornecedor no sistema</span>
                <p id="codError" class="text-red-500 text-sm mt-1 hidden">Código já cadastrado!</p>
            </div>
            <div class="md:col-span-3 tooltip-field">
                <label for="cnpj" class="block text-sm font-medium custom-text-light">CNPJ</label>
                <input type="text" id="cnpj" required
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    placeholder="00.000.000/0000-00">
                <span class="tooltip">Número de identificação fiscal do fornecedor</span>
            </div>
            <div class="md:col-span-5">
                <label for="nomeFornecedor" class="block text-sm font-medium custom-text-light">Nome Fornecedor</label>
                <input type="text" id="nomeFornecedor" required
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    oninput="checkFormValidity()">
            </div>
            <div class="md:col-span-2 tooltip-field">
                <label for="centroCusto" class="block text-sm font-medium custom-text-light">Centro Custo</label>
                <input type="text" id="centroCusto"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light">
                <span class="tooltip">Código do centro de custo associado ao fornecedor</span>
            </div>
            <div class="md:col-span-12 flex justify-center">
                <button type="submit"
                    class="bg-indigo-600 text-white py-2 px-6 rounded-md hover:bg-indigo-700 btn-hover font-medium disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2"
                    id="submitButton" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>Cadastrar</span>
                </button>
            </div>
        </form>

        <!-- Filtros e Ícones -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6 items-end">
            <div class="md:col-span-3">
                <label for="filterNome" class="block text-sm font-medium custom-text-light">Filtrar por Nome</label>
                <input type="text" id="filterNome"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light">
            </div>
            <div class="md:col-span-3">
                <label for="filterCnpj" class="block text-sm font-medium custom-text-light">Filtrar por CNPJ</label>
                <input type="text" id="filterCnpj"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light"
                    placeholder="00.000.000/0000-00">
            </div>
            <div class="md:col-span-3">
                <label for="filterCod" class="block text-sm font-medium custom-text-light">Filtrar por Cód.
                    Fornecedor</label>
                <input type="text" id="filterCod"
                    class="mt-1 block w-full rounded-md custom-border shadow-sm focus:border-indigo-500 p-2 bg-gray-600 border custom-text-light">
            </div>
            <div class="md:col-span-1 flex items-end">
                <div class="dropdown-container">
                    <button id="customFilterButton"
                        class="filter-button bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 btn-hover">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v3.586a1 1 0 01-.293.707l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 01-.293-.707V11.3a1 1 0 00-.293-.707L3.293 4.293A1 1 0 013 3.586V4z" />
                        </svg>
                        <span class="tooltip">Filtro Personalizado</span>
                    </button>
                    <div id="customFilterMenu" class="dropdown-menu filter-dropdown">
                        <div class="filter-group">
                            <label>Cód. Fornecedor</label>
                            <div class="range-container">
                                <input type="text" id="customFilterCodFrom" placeholder="De">
                                <input type="text" id="customFilterCodTo" placeholder="Até">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>CNPJ</label>
                            <div class="range-container">
                                <input type="text" id="customFilterCnpjFrom" placeholder="00.000.000/0000-00">
                                <input type="text" id="customFilterCnpjTo" placeholder="00.000.000/0000-00">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Centro de Custo</label>
                            <div class="range-container">
                                <input type="text" id="customFilterCentroCustoFrom" placeholder="De">
                                <input type="text" id="customFilterCentroCustoTo" placeholder="Até">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button id="applyCustomFilter"
                                class="bg-indigo-600 text-white hover:bg-indigo-700">Aplicar</button>
                            <button id="clearCustomFilter"
                                class="bg-gray-600 text-white hover:bg-gray-700">Limpar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="md:col-span-2 flex justify-end items-end space-x-4">
                <div class="icon-button" id="exportExcel">
                    <img src="./imagens/excel_down.ico" alt="Exportar Excel">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span class="tooltip">Baixar tabela <span
                            style="color: #00ac56; font-size: 14px;">Excel</span></span>
                </div>
                <div class="icon-button" id="exportJson">
                    <img src="./imagens/json_down.ico" alt="Exportar JSON">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span class="tooltip">Baixar <span style="color: #9341ff; font-size: 14px;">.json</span></span>
                </div>
                <label for="importJson" class="icon-button">
                    <img src="./imagens/json_up.ico" alt="Importar JSON">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span class="tooltip">Importar <span style="color: #9341ff; font-size: 14px;">.json</span></span>
                </label>
                <input type="file" id="importJson" accept=".json" class="hidden">
            </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
            <table id="supplierTable" class="w-full text-sm text-left custom-text-light">
                <thead class="text-xs custom-text-light uppercase custom-header-bg sticky-header">
                    <tr>
                        <th class="px-6 py-3" id="quantityHeader">
                            Qtd. (0)
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                Cód. Fornecedor
                                <span class="sort-icon" onclick="sortTable('codFornecedor', 'numeric')"
                                    data-tooltip="Ordem numérica">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem numérica</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                CNPJ
                                <span class="sort-icon" onclick="sortTable('cnpj', 'numeric')"
                                    data-tooltip="Ordem numérica">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem numérica</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                Nome Fornecedor
                                <span class="sort-icon" onclick="sortTable('nomeFornecedor', 'string')"
                                    data-tooltip="Ordem alfabética">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem alfabética</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            <div class="flex items-center justify-between">
                                Centro de Custo
                                <span class="sort-icon" onclick="sortTable('centroCusto', 'numeric')"
                                    data-tooltip="Ordem numérica">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span class="tooltip">Ordem numérica</span>
                                </span>
                            </div>
                        </th>
                        <th class="px-6 py-3">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let currentSort = { column: null, direction: 'asc', type: null };
        let validateCodFornecedor = true;
        let customFilters = {
            codFornecedor: { from: '', to: '' },
            cnpj: { from: '', to: '' },
            centroCusto: { from: '', to: '' }
        };

        // Validar código do fornecedor
        function checkCodFornecedor(cod) {
            if (!validateCodFornecedor) {
                document.getElementById('codError').classList.add('hidden');
                return true;
            }
            const codError = document.getElementById('codError');
            const editIndex = document.getElementById('supplierForm').dataset.editIndex;
            const codExists = suppliers.some((s, i) => s.codFornecedor === cod.trim() && (editIndex ? i !== parseInt(editIndex) : true));
            if (codExists && cod.trim() !== '') {
                codError.classList.remove('hidden');
                return false;
            } else {
                codError.classList.add('hidden');
                return true;
            }
        }

        // Validar formulário e ativar/desativar botão
        function checkFormValidity() {
            const codFornecedor = document.getElementById('codFornecedor').value.trim();
            const cnpj = document.getElementById('cnpj').value.trim();
            const nomeFornecedor = document.getElementById('nomeFornecedor').value.trim();
            const submitButton = document.getElementById('submitButton');
            const isCodValid = checkCodFornecedor(codFornecedor);
            submitButton.disabled = !(isCodValid && codFornecedor && cnpj && nomeFornecedor);
        }

        // Validar CNPJ com dígitos verificadores
        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g, '');
            if (cnpj === '') return false;
            if (cnpj.length !== 14) return false;
            if (/^(\d)\1+$/.test(cnpj)) return false;
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;
            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(1)) return false;
            return true;
        }

        // Formatar CNPJ corretamente
        function formatCNPJ(cnpj, isInput = true) {
            let value = isInput ? cnpj.replace(/\D/g, '') : cnpj.toString().replace(/\D/g, '');
            if (value.length > 2) value = value.substring(0, 2) + '.' + value.substring(2);
            if (value.length > 6) value = value.substring(0, 6) + '.' + value.substring(6);
            if (value.length > 10) value = value.substring(0, 10) + '/' + value.substring(10);
            if (value.length > 15) value = value.substring(0, 15) + '-' + value.substring(15);
            value = value.substring(0, 18);
            return value;
        }

        // Formatar CNPJ no campo principal
        document.getElementById('cnpj').addEventListener('input', function (e) {
            const start = e.target.selectionStart;
            const end = e.target.selectionEnd;
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) value = value.substring(0, 2) + '.' + value.substring(2);
            if (value.length > 6) value = value.substring(0, 6) + '.' + value.substring(6);
            if (value.length > 10) value = value.substring(0, 10) + '/' + value.substring(10);
            if (value.length > 15) value = value.substring(0, 15) + '-' + value.substring(15);
            value = value.substring(0, 18);
            e.target.value = value;
            let adjustedStart = start;
            let adjustedEnd = end;
            if (start > 2 && value.charAt(2) === '.') adjustedStart += 1;
            if (start > 6 && value.charAt(6) === '.') adjustedStart += 1;
            if (start > 10 && value.charAt(10) === '/') adjustedStart += 1;
            if (start > 15 && value.charAt(15) === '-') adjustedStart += 1;
            if (end > 2 && value.charAt(2) === '.') adjustedEnd += 1;
            if (end > 6 && value.charAt(6) === '.') adjustedEnd += 1;
            if (end > 10 && value.charAt(10) === '/') adjustedEnd += 1;
            if (end > 15 && value.charAt(15) === '-') adjustedEnd += 1;
            e.target.setSelectionRange(adjustedStart, adjustedEnd);
            if (value.length === 18 && validarCNPJ(value)) {
                fetchCNPJData(value);
            }
            checkFormValidity();
        });

        // Formatar e filtrar CNPJ no campo de filtro
        document.getElementById('filterCnpj').addEventListener('input', function (e) {
            const start = e.target.selectionStart;
            const end = e.target.selectionEnd;
            let value = e.target.value.replace(/\D/g, '');
            let formattedValue = value;
            if (value.length > 2) formattedValue = value.substring(0, 2) + '.' + value.substring(2);
            if (value.length > 5) formattedValue = formattedValue.substring(0, 6) + '.' + formattedValue.substring(6);
            if (value.length > 8) formattedValue = formattedValue.substring(0, 10) + '/' + formattedValue.substring(10);
            if (value.length > 12) formattedValue = formattedValue.substring(0, 15) + '-' + formattedValue.substring(15);
            formattedValue = formattedValue.substring(0, 18);
            e.target.value = formattedValue;
            let adjustedStart = start;
            let adjustedEnd = end;
            if (value.length >= 3 && start > 2) adjustedStart += 1;
            if (value.length >= 6 && start > 6) adjustedStart += 1;
            if (value.length >= 9 && start > 10) adjustedStart += 1;
            if (value.length >= 13 && start > 15) adjustedStart += 1;
            if (value.length >= 3 && end > 2) adjustedEnd += 1;
            if (value.length >= 6 && end > 6) adjustedEnd += 1;
            if (value.length >= 9 && end > 10) adjustedEnd += 1;
            if (value.length >= 13 && end > 15) adjustedEnd += 1;
            e.target.setSelectionRange(adjustedStart, adjustedEnd);
            updateTable();
        });

        // Formatar CNPJ nos campos de filtro personalizado
        ['customFilterCnpjFrom', 'customFilterCnpjTo'].forEach(id => {
            document.getElementById(id).addEventListener('input', function (e) {
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = value;
                if (value.length > 2) formattedValue = value.substring(0, 2) + '.' + value.substring(2);
                if (value.length > 5) formattedValue = formattedValue.substring(0, 6) + '.' + formattedValue.substring(6);
                if (value.length > 8) formattedValue = formattedValue.substring(0, 10) + '/' + formattedValue.substring(10);
                if (value.length > 12) formattedValue = formattedValue.substring(0, 15) + '-' + formattedValue.substring(15);
                formattedValue = formattedValue.substring(0, 18);
                e.target.value = formattedValue;
                let adjustedStart = start;
                let adjustedEnd = end;
                if (value.length >= 3 && start > 2) adjustedStart += 1;
                if (value.length >= 6 && start > 6) adjustedStart += 1;
                if (value.length >= 9 && start > 10) adjustedStart += 1;
                if (value.length >= 13 && start > 15) adjustedStart += 1;
                if (value.length >= 3 && end > 2) adjustedEnd += 1;
                if (value.length >= 6 && end > 6) adjustedEnd += 1;
                if (value.length >= 9 && end > 10) adjustedEnd += 1;
                if (value.length >= 13 && end > 15) adjustedEnd += 1;
                e.target.setSelectionRange(adjustedStart, adjustedEnd);
            });
        });

        // Consultar CNPJ com loading
        async function fetchCNPJData(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (!validarCNPJ(cnpj)) return;
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                if (!response.ok) {
                    throw new Error('CNPJ não encontrado ou erro na API');
                }
                const data = await response.json();
                if (data.razao_social) {
                    document.getElementById('nomeFornecedor').value = data.razao_social;
                    checkFormValidity();
                    Swal.fire({
                        title: 'Dados encontrados!',
                        text: `Razão social: ${data.razao_social}`,
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            } catch (error) {
                console.error('Erro ao consultar CNPJ:', error);
                Swal.fire({
                    title: 'Erro na consulta',
                    text: error.message,
                    icon: 'error',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Salvar dados no localStorage
        function saveData() {
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
        }

        // Adicionar ou atualizar fornecedor
        document.getElementById('supplierForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const codFornecedor = document.getElementById('codFornecedor').value.trim();
            const cnpj = document.getElementById('cnpj').value.trim();
            const nomeFornecedor = document.getElementById('nomeFornecedor').value.trim();
            const centroCusto = document.getElementById('centroCusto').value.trim();
            const editIndex = this.dataset.editIndex;

            if (!validarCNPJ(cnpj)) {
                Swal.fire({
                    title: 'CNPJ inválido!',
                    text: 'Por favor, insira um CNPJ válido com dígitos verificadores corretos.',
                    icon: 'error',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }

            if (editIndex) {
                suppliers[parseInt(editIndex)] = {
                    codFornecedor,
                    cnpj: cnpj.replace(/\D/g, ''),
                    nomeFornecedor,
                    centroCusto,
                    timestamp: suppliers[parseInt(editIndex)].timestamp
                };
                delete this.dataset.editIndex;
                Swal.fire({
                    title: 'Fornecedor atualizado!',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                const cnpjExists = suppliers.some(s => s.cnpj === cnpj.replace(/\D/g, ''));
                if (cnpjExists) {
                    Swal.fire({
                        title: 'CNPJ já cadastrado!',
                        text: 'Este CNPJ já está cadastrado no sistema.',
                        icon: 'warning',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    return;
                }
                suppliers.push({
                    codFornecedor,
                    cnpj: cnpj.replace(/\D/g, ''),
                    nomeFornecedor,
                    centroCusto,
                    timestamp: new Date().getTime()
                });
                Swal.fire({
                    title: 'Fornecedor cadastrado!',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            }

            saveData();
            updateTable();
            this.reset();
            checkFormValidity();
        });

        // Copiar texto com confirmação visual
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                });
                toast.fire({
                    icon: 'success',
                    title: 'Conteúdo copiado!'
                });
                element.classList.add('copied');
                setTimeout(() => element.classList.remove('copied'), 1500);
            });
        }

        // Ordenar tabela
        function sortTable(column, type) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
                currentSort.type = type;
            }

            const sortIcon = document.querySelector(`.sort-icon[onclick*="sortTable('${column}'"]`);
            const tooltip = sortIcon.querySelector('.tooltip');
            let newTooltipText = column === 'nomeFornecedor'
                ? (sortIcon.dataset.tooltip === 'Ordem alfabética' ? 'Ordem por criação' : 'Ordem alfabética')
                : (sortIcon.dataset.tooltip === 'Ordem numérica' ? 'Ordem por criação' : 'Ordem numérica');
            sortIcon.dataset.tooltip = newTooltipText;
            tooltip.textContent = newTooltipText;

            suppliers.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                if (column === 'cnpj') {
                    valueA = valueA.replace(/\D/g, '');
                    valueB = valueB.replace(/\D/g, '');
                }
                if (type === 'numeric') {
                    valueA = Number(valueA) || 0;
                    valueB = Number(valueB) || 0;
                } else if (type === 'date') {
                    valueA = new Date(valueA).getTime();
                    valueB = new Date(valueB).getTime();
                } else {
                    valueA = String(valueA).toLowerCase();
                    valueB = String(valueB).toLowerCase();
                }
                if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            updateTable();
        }

        // Atualizar tabela
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            const filterCod = document.getElementById('filterCod').value.toLowerCase();
            const filterCnpj = document.getElementById('filterCnpj').value.replace(/\D/g, '');
            const filterNome = document.getElementById('filterNome').value.toLowerCase();

            const filteredSuppliers = suppliers.filter(supplier => {
                const cleanCnpj = supplier.cnpj.replace(/\D/g, '');
                const codFornecedor = supplier.codFornecedor.toLowerCase();
                const centroCusto = supplier.centroCusto.toLowerCase();
                const { codFornecedor: codFilter, cnpj: cnpjFilter, centroCusto: centroCustoFilter } = customFilters;

                const codMatch = (!codFilter.from || codFornecedor >= codFilter.from.toLowerCase()) &&
                    (!codFilter.to || codFornecedor <= codFilter.to.toLowerCase());
                const cnpjMatch = (!cnpjFilter.from || cleanCnpj >= cnpjFilter.from.replace(/\D/g, '')) &&
                    (!cnpjFilter.to || cleanCnpj <= cnpjFilter.to.replace(/\D/g, ''));
                const centroCustoMatch = (!centroCustoFilter.from || centroCusto >= centroCustoFilter.from.toLowerCase()) &&
                    (!centroCustoFilter.to || centroCusto <= centroCustoFilter.to.toLowerCase());

                return (
                    codFornecedor.includes(filterCod) &&
                    cleanCnpj.includes(filterCnpj) &&
                    supplier.nomeFornecedor.toLowerCase().includes(filterNome) &&
                    codMatch &&
                    cnpjMatch &&
                    centroCustoMatch
                );
            });

            document.getElementById('quantityHeader').textContent = `Qtd. (${filteredSuppliers.length})`;

            tableBody.innerHTML = '';
            filteredSuppliers.forEach((supplier, index) => {
                const globalIndex = suppliers.findIndex(s => s.codFornecedor === supplier.codFornecedor && s.cnpj === supplier.cnpj);
                const row = document.createElement('tr');
                row.className = 'bg-gray-700 border-b custom-hover-indigo';
                row.innerHTML = `
                    <td class="px-6 py-4 custom-text-light">${index + 1}</td>
                    <td class="px-6 py-4 copyable custom-text-light" onclick="copyToClipboard('${supplier.codFornecedor}', this)">${supplier.codFornecedor}</td>
                    <td class="px-6 py-4 copyable custom-text-light" onclick="copyToClipboard('${formatCNPJ(supplier.cnpj, false)}', this)">${formatCNPJ(supplier.cnpj, false)}</td>
                    <td class="px-6 py-4 copyable custom-text-light" onclick="copyToClipboard('${supplier.nomeFornecedor}', this)">${supplier.nomeFornecedor}</td>
                    <td class="px-6 py-4">
                        <input type="text" value="${supplier.centroCusto}" class="w-full border rounded p-1 bg-gray-600 custom-border custom-text-light"
                            onchange="updateCostCenter(${globalIndex}, this.value)">
                    </td>
                    <td class="px-6 py-4 flex space-x-2">
                        <button onclick="editSupplier(${globalIndex})" class="custom-text-indigo hover:text-indigo-200 btn-hover">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${globalIndex})" class="text-red-400 hover:text-red-300 btn-hover">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4M9 7v12m6-12v12" />
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active', 'desc');
            });

            const currentIcon = document.querySelector(`.sort-icon[onclick*="${currentSort.column}"]`);
            if (currentIcon) {
                currentIcon.classList.add('active');
                if (currentSort.direction === 'desc') {
                    currentIcon.classList.add('desc');
                }
            }
        }

        // Atualizar centro de custo
        function updateCostCenter(index, value) {
            suppliers[index].centroCusto = value;
            saveData();
            updateTable();
        }

        // Editar fornecedor
        function editSupplier(index) {
            const supplier = suppliers[index];
            document.getElementById('codFornecedor').value = supplier.codFornecedor;
            document.getElementById('cnpj').value = formatCNPJ(supplier.cnpj, false);
            document.getElementById('nomeFornecedor').value = supplier.nomeFornecedor;
            document.getElementById('centroCusto').value = supplier.centroCusto;
            document.getElementById('supplierForm').dataset.editIndex = index;
            checkFormValidity();
            document.getElementById('supplierForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Confirmar exclusão
        function confirmDelete(index) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Você não poderá reverter isso! Exclusão em 3 segundos.",
                icon: 'warning',
                showCancelButton: true,
                cancelButtonColor: '#ef4444',
                cancelButtonText: 'Cancelar',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            }).then((result) => {
                if (result.isConfirmed || result.dismiss === Swal.DismissReason.timer) {
                    suppliers.splice(index, 1);
                    saveData();
                    updateTable();
                    Swal.fire({
                        title: 'Excluído!',
                        text: 'O fornecedor foi removido.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            });
        }

        // Configurações: Alternar validação de código
        document.getElementById('toggleCodValidation').addEventListener('click', function () {
            validateCodFornecedor = !validateCodFornecedor;
            document.getElementById('validateCod').checked = validateCodFornecedor;
            checkFormValidity();
            Swal.fire({
                title: `Validação de código ${validateCodFornecedor ? 'ativada' : 'desativada'}`,
                icon: 'info',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Configurações: Apagar todos os dados
        document.getElementById('clearAllData').addEventListener('click', function () {
            Swal.fire({
                title: 'Apagar todos os dados?',
                text: 'Digite "CONFIRMAR" para prosseguir. Esta ação é irreversível!',
                input: 'text',
                inputPlaceholder: 'Digite CONFIRMAR',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                confirmButtonText: 'Apagar',
                showLoaderOnConfirm: true,
                preConfirm: (input) => {
                    if (input !== 'CONFIRMAR') {
                        Swal.showValidationMessage('Digite exatamente "CONFIRMAR"');
                        return false;
                    }
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    suppliers = [];
                    saveData();
                    updateTable();
                    Swal.fire({
                        title: 'Dados apagados!',
                        text: 'Todos os fornecedores foram removidos.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            });
        });

        // Alternar menu de configurações
        document.getElementById('settingsButton').addEventListener('click', function () {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
        });

        // Fechar menu de configurações ao clicar fora
        document.addEventListener('click', function (e) {
            const settingsButton = document.getElementById('settingsButton');
            const settingsMenu = document.getElementById('settingsMenu');
            if (!settingsButton.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });

        // Alternar menu de filtro personalizado
        document.getElementById('customFilterButton').addEventListener('click', function () {
            const menu = document.getElementById('customFilterMenu');
            menu.classList.toggle('show');
        });

        // Aplicar filtro personalizado
        document.getElementById('applyCustomFilter').addEventListener('click', function () {
            customFilters.codFornecedor.from = document.getElementById('customFilterCodFrom').value;
            customFilters.codFornecedor.to = document.getElementById('customFilterCodTo').value;
            customFilters.cnpj.from = document.getElementById('customFilterCnpjFrom').value;
            customFilters.cnpj.to = document.getElementById('customFilterCnpjTo').value;
            customFilters.centroCusto.from = document.getElementById('customFilterCentroCustoFrom').value;
            customFilters.centroCusto.to = document.getElementById('customFilterCentroCustoTo').value;
            updateTable();
            document.getElementById('customFilterMenu').classList.remove('show');
            Swal.fire({
                title: 'Filtro aplicado!',
                icon: 'success',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Limpar filtro personalizado
        document.getElementById('clearCustomFilter').addEventListener('click', function () {
            customFilters = {
                codFornecedor: { from: '', to: '' },
                cnpj: { from: '', to: '' },
                centroCusto: { from: '', to: '' }
            };
            document.getElementById('customFilterCodFrom').value = '';
            document.getElementById('customFilterCodTo').value = '';
            document.getElementById('customFilterCnpjFrom').value = '';
            document.getElementById('customFilterCnpjTo').value = '';
            document.getElementById('customFilterCentroCustoFrom').value = '';
            document.getElementById('customFilterCentroCustoTo').value = '';
            updateTable();
            document.getElementById('customFilterMenu').classList.remove('show');
            Swal.fire({
                title: 'Filtros limpos!',
                icon: 'success',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Fechar menu de filtro ao clicar fora
        document.addEventListener('click', function (e) {
            const filterButton = document.getElementById('customFilterButton');
            const filterMenu = document.getElementById('customFilterMenu');
            if (!filterButton.contains(e.target) && !filterMenu.contains(e.target)) {
                filterMenu.classList.remove('show');
            }
        });

        // Exportar JSON (apenas dados filtrados)
        document.getElementById('exportJson').addEventListener('click', function () {
            const filterCod = document.getElementById('filterCod').value.toLowerCase();
            const filterCnpj = document.getElementById('filterCnpj').value.replace(/\D/g, '');
            const filterNome = document.getElementById('filterNome').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => {
                const cleanCnpj = supplier.cnpj.replace(/\D/g, '');
                const codFornecedor = supplier.codFornecedor.toLowerCase();
                const centroCusto = supplier.centroCusto.toLowerCase();
                const { codFornecedor: codFilter, cnpj: cnpjFilter, centroCusto: centroCustoFilter } = customFilters;

                const codMatch = (!codFilter.from || codFornecedor >= codFilter.from.toLowerCase()) &&
                    (!codFilter.to || codFornecedor <= codFilter.to.toLowerCase());
                const cnpjMatch = (!cnpjFilter.from || cleanCnpj >= cnpjFilter.from.replace(/\D/g, '')) &&
                    (!cnpjFilter.to || cleanCnpj <= cnpjFilter.to.replace(/\D/g, ''));
                const centroCustoMatch = (!centroCustoFilter.from || centroCusto >= centroCustoFilter.from.toLowerCase()) &&
                    (!centroCustoFilter.to || centroCusto <= centroCustoFilter.to.toLowerCase());

                return (
                    codFornecedor.includes(filterCod) &&
                    cleanCnpj.includes(filterCnpj) &&
                    supplier.nomeFornecedor.toLowerCase().includes(filterNome) &&
                    codMatch &&
                    cnpjMatch &&
                    centroCustoMatch
                );
            });

            if (filteredSuppliers.length === 0) {
                Swal.fire({
                    title: 'Nenhum dado para exportar',
                    text: 'Adicione fornecedores ou ajuste os filtros',
                    icon: 'warning',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }
            const exportData = filteredSuppliers.map(s => ({
                codFornecedor: s.codFornecedor,
                cnpj: s.cnpj,
                nomeFornecedor: s.nomeFornecedor,
                centroCusto: s.centroCusto,
                timestamp: s.timestamp
            }));
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fornecedores_filtrados.json';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire({
                title: 'Exportado com sucesso!',
                text: 'O arquivo JSON foi gerado.',
                icon: 'success',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Importar JSON (mesclar sem excluir)
        document.getElementById('importJson').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error('Arquivo JSON deve conter uma lista de fornecedores');

                    const invalidEntries = [];
                    const validEntries = [];
                    const existingCnpjs = new Set(suppliers.map(s => s.cnpj));
                    const existingCodes = new Set(suppliers.map(s => s.codFornecedor));

                    importedData.forEach((s, index) => {
                        const isValid = (
                            s.codFornecedor &&
                            typeof s.codFornecedor === 'string' &&
                            s.cnpj &&
                            validarCNPJ(s.cnpj) &&
                            s.nomeFornecedor &&
                            typeof s.nomeFornecedor === 'string' &&
                            (s.centroCusto === undefined || typeof s.centroCusto === 'string') &&
                            s.timestamp &&
                            typeof s.timestamp === 'number' &&
                            (!validateCodFornecedor || !existingCodes.has(s.codFornecedor)) &&
                            !existingCnpjs.has(s.cnpj)
                        );
                        if (isValid) {
                            validEntries.push(s);
                            existingCnpjs.add(s.cnpj);
                            existingCodes.add(s.codFornecedor);
                        } else {
                            invalidEntries.push({ index: index + 1, data: s, reason: getInvalidReason(s) });
                        }
                    });

                    if (validEntries.length > 0) {
                        suppliers = [...suppliers, ...validEntries];
                        saveData();
                        updateTable();
                    }

                    if (invalidEntries.length > 0) {
                        const invalidDataStr = JSON.stringify(invalidEntries.map(e => ({ ...e.data, reason: e.reason })), null, 2);
                        const blob = new Blob([invalidDataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        Swal.fire({
                            title: 'Importação parcial',
                            text: `${validEntries.length} fornecedores importados. ${invalidEntries.length} registros inválidos. Deseja baixar o arquivo com os erros?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Baixar erros',
                            cancelButtonText: 'Fechar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'fornecedores_invalidos.json';
                                a.click();
                                URL.revokeObjectURL(url);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Importado com sucesso!',
                            text: `${validEntries.length} fornecedores importados.`,
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'Erro na importação',
                        text: error.message,
                        icon: 'error',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                } finally {
                    document.getElementById('importJson').value = ''; // Resetar input para permitir nova importação
                }
            };
            reader.readAsText(file);
        });

        function getInvalidReason(s) {
            if (!s.codFornecedor || typeof s.codFornecedor !== 'string') return 'Código do fornecedor inválido';
            if (!s.cnpj || !validarCNPJ(s.cnpj)) return 'CNPJ inválido';
            if (!s.nomeFornecedor || typeof s.nomeFornecedor !== 'string') return 'Nome do fornecedor inválido';
            if (s.centroCusto !== undefined && typeof s.centroCusto !== 'string') return 'Centro de custo inválido';
            if (!s.timestamp || typeof s.timestamp !== 'number') return 'Timestamp inválido';
            if (validateCodFornecedor && new Set(suppliers.map(s => s.codFornecedor)).has(s.codFornecedor)) return 'Código do fornecedor duplicado';
            if (new Set(suppliers.map(s => s.cnpj)).has(s.cnpj)) return 'CNPJ duplicado';
            return 'Erro desconhecido';
        }

        // Exportar para Excel (apenas dados filtrados)
        document.getElementById('exportExcel').addEventListener('click', function () {
            const filterCod = document.getElementById('filterCod').value.toLowerCase();
            const filterCnpj = document.getElementById('filterCnpj').value.replace(/\D/g, '');
            const filterNome = document.getElementById('filterNome').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => {
                const cleanCnpj = supplier.cnpj.replace(/\D/g, '');
                const codFornecedor = supplier.codFornecedor.toLowerCase();
                const centroCusto = supplier.centroCusto.toLowerCase();
                const { codFornecedor: codFilter, cnpj: cnpjFilter, centroCusto: centroCustoFilter } = customFilters;

                const codMatch = (!codFilter.from || codFornecedor >= codFilter.from.toLowerCase()) &&
                    (!codFilter.to || codFornecedor <= codFilter.to.toLowerCase());
                const cnpjMatch = (!cnpjFilter.from || cleanCnpj >= cnpjFilter.from.replace(/\D/g, '')) &&
                    (!cnpjFilter.to || cleanCnpj <= cnpjFilter.to.replace(/\D/g, ''));
                const centroCustoMatch = (!centroCustoFilter.from || centroCusto >= centroCustoFilter.from.toLowerCase()) &&
                    (!centroCustoFilter.to || centroCusto <= centroCustoFilter.to.toLowerCase());

                return (
                    codFornecedor.includes(filterCod) &&
                    cleanCnpj.includes(filterCnpj) &&
                    supplier.nomeFornecedor.toLowerCase().includes(filterNome) &&
                    codMatch &&
                    cnpjMatch &&
                    centroCustoMatch
                );
            });

            if (filteredSuppliers.length === 0) {
                Swal.fire({
                    title: 'Nenhum dado para exportar',
                    text: 'Adicione fornecedores ou ajuste os filtros',
                    icon: 'warning',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }
            const data = filteredSuppliers.map(s => ({
                'Cód. Fornecedor': s.codFornecedor,
                'CNPJ': formatCNPJ(s.cnpj, false),
                'Nome Fornecedor': s.nomeFornecedor,
                'Centro de Custo': s.centroCusto,
                'Data Cadastro': new Date(s.timestamp).toLocaleString()
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Fornecedores');
            XLSX.writeFile(wb, 'fornecedores_filtrados.xlsx');
            Swal.fire({
                title: 'Exportado com sucesso!',
                text: 'O arquivo Excel foi gerado.',
                icon: 'success',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });

        // Filtros automáticos
        document.getElementById('filterCod').addEventListener('input', updateTable);
        document.getElementById('filterNome').addEventListener('input', updateTable);
        document.getElementById('nomeFornecedor').addEventListener('input', checkFormValidity);
        document.getElementById('codFornecedor').addEventListener('input', checkFormValidity);

        // Carregar tabela ao iniciar
        updateTable();
    </script>
</body>

</html>
